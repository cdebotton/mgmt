// Generated by CoffeeScript 1.4.0
(function() {
  var __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  define(['backbone', 'underscore', 'jquery', 'mousetrap', 'ns', 'views/profile-palette', 'views/task-timeline', 'views/graph-timeline', 'views/date-guides', 'views/edit-modal', 'models/edit-modal', 'models/task', 'views/scale-controller', 'models/scale-controller', 'views/graph-filters', 'models/graph-filters', 'views/view-selector', 'models/view-selector', 'views/calendar'], function(Backbone, _, $, Mousetrap, namespace) {
    namespace('BU.EventBus');
    BU.EventBus = _.extend({}, Backbone.Events);
    namespace('BU.Views.App');
    return BU.Views.App = (function(_super) {
      var MODAL_OPEN;

      __extends(App, _super);

      function App() {
        this.openModal = __bind(this.openModal, this);

        this.createNewTask = __bind(this.createNewTask, this);

        this.adjust = __bind(this.adjust, this);

        this.affix = __bind(this.affix, this);
        return App.__super__.constructor.apply(this, arguments);
      }

      App.prototype.el = '#schedule-viewport';

      MODAL_OPEN = false;

      App.prototype.events = {
        'selectstart': 'disableSelection',
        'click #new-task-toggle': 'createNewTask'
      };

      App.prototype.initialize = function() {
        var _this = this;
        BU.EventBus.on('modal-closed', this.modalClosed, this);
        this.model.get('session').on('change:id', this.authed, this);
        this.model.get('session').fetch();
        return Mousetrap.bind(['ctrl+shift+command+n', 'ctrl+shift+alt+n'], function() {
          return _this.openModal();
        });
      };

      App.prototype.authed = function(model, value, changes) {
        BU.EventBus.on('open-modal', this.openModal, this);
        BU.EventBus.on('set-view', this.setView, this);
        BU.Session = this.model.get('session');
        this.window = $(window);
        this.header = this.$('.navbar');
        this.dy = this.$el.offset().top;
        this.window.on('scroll', this.affix);
        this.window.on('resize', this.adjust);
        this.sub_views = _.extend({}, {
          graphFilters: new BU.Views.GraphFilters({
            model: new BU.Models.GraphFilters
          }),
          viewSelector: new BU.Views.ViewSelector({
            model: new BU.Models.ViewSelector
          }),
          scaleController: new BU.Views.ScaleController({
            model: new BU.Models.ScaleController
          })
        });
        this.task_views = _.extend({}, {
          graphTimeline: new BU.Views.GraphTimeline({
            model: this.model
          }),
          profilePalette: new BU.Views.ProfilePalette({
            model: this.model
          }),
          taskTimeline: new BU.Views.TaskTimeline({
            model: this.model
          })
        });
        this.calendar_views = _.extend({}, {
          calendarView: new BU.Views.CalendarView({
            model: this.model
          })
        });
        this.adjust();
        return this.sub_views.viewSelector.model.set('currentView', 'task');
      };

      App.prototype.disableSelection = function(e) {
        return e.preventDefault();
      };

      App.prototype.affix = function(e) {
        var scrollTop;
        scrollTop = this.window.scrollTop();
        BU.EventBus.trigger('on-scroll', scrollTop);
        if (scrollTop > this.dy) {
          this.header.addClass('affix');
          return BU.EventBus.trigger('nav-affix', true);
        } else {
          this.header.removeClass('affix');
          return BU.EventBus.trigger('nav-affix', false);
        }
      };

      App.prototype.adjust = function(e) {
        var h, w;
        w = this.window.width();
        h = this.window.height();
        return BU.EventBus.trigger('adjust', w, h);
      };

      App.prototype.createNewTask = function(e) {
        this.openModal();
        return e.preventDefault();
      };

      App.prototype.openModal = function(task) {
        var params;
        if (task == null) {
          task = null;
        }
        if (MODAL_OPEN) {
          return false;
        }
        MODAL_OPEN = true;
        if (!BU.Session.isAdmin()) {
          return false;
        }
        params = {};
        params['users'] = this.model.get('users');
        if (task !== null) {
          params['task'] = task;
        }
        this.modal = new BU.Views.EditModal({
          model: new BU.Models.EditModal(params)
        });
        this.$el.append(this.modal.render().$el);
        return false;
      };

      App.prototype.modalClosed = function() {
        return MODAL_OPEN = false;
      };

      App.prototype.setView = function(type) {
        switch (type) {
          case 'task':
            _.each(this.task_views, function(view) {
              view.startListening();
              return view.$el.show();
            });
            return _.each(this.calendar_views, function(view) {
              view.stopListening();
              return view.$el.hide();
            });
          case 'calendar':
            _.each(this.task_views, function(view) {
              view.stopListening();
              return view.$el.hide();
            });
            _.each(this.calendar_views, function(view) {
              view.startListening();
              return view.$el.show();
            });
            return this.calendar_views.calendarView.addAll();
        }
      };

      return App;

    })(Backbone.View);
  });

}).call(this);

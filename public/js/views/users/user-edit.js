// Generated by CoffeeScript 1.4.0
(function() {
  var __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  define(['backbone', 'ns', 'jst', 'animate'], function(Backbone, ns) {
    ns('United.Views.Users.UserEdit');
    return United.Views.Users.UserEdit = (function(_super) {
      var MONTHS;

      __extends(UserEdit, _super);

      function UserEdit() {
        this.close = __bind(this.close, this);

        this.cancelUser = __bind(this.cancelUser, this);

        this.saveUser = __bind(this.saveUser, this);

        this.updateConfirmPassword = __bind(this.updateConfirmPassword, this);

        this.updatePassword = __bind(this.updatePassword, this);

        this.updatePdo = __bind(this.updatePdo, this);

        this.updateHiredOnYear = __bind(this.updateHiredOnYear, this);

        this.updateHiredOnDay = __bind(this.updateHiredOnDay, this);

        this.updateHiredOnMonth = __bind(this.updateHiredOnMonth, this);

        this.updateEmail = __bind(this.updateEmail, this);

        this.updateLastName = __bind(this.updateLastName, this);

        this.updateFirstName = __bind(this.updateFirstName, this);
        return UserEdit.__super__.constructor.apply(this, arguments);
      }

      UserEdit.prototype.el = '#user-drawer';

      MONTHS = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

      UserEdit.prototype.events = {
        'keyup [name="first-name"]': 'updateFirstName',
        'keyup [name="last-name"]': 'updateLastName',
        'keyup [name="email"]': 'updateEmail',
        'keyup [name="hired-on-month"]': 'updateHiredOnMonth',
        'keyup [name="hired-on-day"]': 'updateHiredOnDay',
        'keyup [name="hired-on-year"]': 'updateHiredOnYear',
        'keyup [name="pdo"]': 'updatePdo',
        'keyup [name="password"]': 'updatePassword',
        'keyup [name="confrim-password"]': 'updateConfirmPassword',
        'click #save-user': 'saveUser',
        'click #cancel-user': 'cancelUser',
        'click .icon-remove': 'close'
      };

      UserEdit.prototype.initialize = function() {
        United.JST.Hb.registerHelper('printLogin', this.printLogin);
        this.model.on('change:first_name change:last_name', this.updateTitle, this);
        return this.model.on('destroy', this.close, this);
      };

      UserEdit.prototype.updateFirstName = function(e) {
        return this.model.set('first_name', e.currentTarget.value);
      };

      UserEdit.prototype.updateLastName = function(e) {
        return this.model.set('last_name', e.currentTarget.value);
      };

      UserEdit.prototype.updateEmail = function(e) {
        return this.model.set('email', e.currentTarget.value);
      };

      UserEdit.prototype.updateHiredOnMonth = function(e) {
        var d, v;
        v = parseInt(e.currentTarget.value);
        if ((0 < v && v < 13)) {
          d = new Date(this.model.get('hired_on'));
          d.setMonth(v - 1);
          return this.model.set('hired_on', d);
        }
      };

      UserEdit.prototype.updateHiredOnDay = function(e) {
        var d, v;
        v = parseInt(e.currentTarget.value);
        if ((0 < v && v < 32)) {
          d = new Date(this.model.get('hired_on'));
          d.setDate(v);
          return this.model.set('hired_on', d);
        }
      };

      UserEdit.prototype.updateHiredOnYear = function(e) {
        var d, v;
        v = e.currentTarget.value;
        if (v.match(/^\d{4}$/)) {
          v = parseInt(v);
          d = new Date(this.model.get('hired_on'));
          d.setYear(parseInt(e.currentTarget.value));
          return this.model.set('hired_on', d);
        }
      };

      UserEdit.prototype.updatePdo = function(e) {
        return this.model.set('pdo_allotment', e.currentTarget.value);
      };

      UserEdit.prototype.updatePassword = function(e) {};

      UserEdit.prototype.updateConfirmPassword = function(e) {};

      UserEdit.prototype.updateTitle = function(model, value, status) {
        return this.title.html("" + (this.model.get('first_name')) + " " + (this.model.get('last_name')));
      };

      UserEdit.prototype.saveUser = function(e) {
        var _this = this;
        this.model.save(null, {
          wait: true,
          success: function() {
            return _this.close(e);
          }
        });
        return e.preventDefault();
      };

      UserEdit.prototype.cancelUser = function(e) {
        var _this = this;
        if (this.model.isNew()) {
          this.model.destroy();
          this.close(e);
        } else {
          this.model.fetch({
            wait: true,
            success: function() {
              return _this.close(e);
            }
          });
        }
        return e.preventDefault();
      };

      UserEdit.prototype.render = function() {
        var ctx, h, html;
        ctx = this.model.toJSON();
        ctx.hired_on_month = parseInt(ctx.hired_on.getMonth()) + 1;
        ctx.hired_on_day = ctx.hired_on.getDate();
        ctx.hired_on_year = ctx.hired_on.getFullYear();
        html = United.JST.UserEdit(ctx);
        this.$el.html(html);
        this.title = this.$('#username');
        if (this.options.open === false) {
          h = this.$el.innerHeight() + 10;
          this.$el.css({
            marginTop: -h,
            display: 'block'
          }).animate({
            marginTop: 0
          }, '175', 'ease-out');
        }
        return this;
      };

      UserEdit.prototype.close = function(e) {
        var h,
          _this = this;
        h = this.$el.innerHeight() + 10;
        this.$el.animate({
          marginTop: -h
        }, '175', 'ease-in', function() {
          United.EventBus.trigger('user-edit-closed');
          _this.$el.html('');
          return _this.$el.css({
            marginTop: 0,
            display: 'none'
          });
        });
        if (e.hasOwnProperty('preventDefault')) {
          return e.preventDefault();
        }
      };

      UserEdit.prototype.printLogin = function(d, name) {
        var h, m;
        if (isNaN(d.getTime())) {
          return "" + name + " has never logged in.";
        } else {
          h = d.getHours();
          if (h < 10) {
            h = "0" + h;
          }
          m = d.getMinutes();
          if (m < 10) {
            m = "0" + m;
          }
          return "<strong>Last seen</strong> " + MONTHS[d.getMonth()] + " " + (d.getDate()) + ", " + (d.getFullYear()) + " at " + h + ":" + m;
        }
      };

      return UserEdit;

    })(Backbone.View);
  });

}).call(this);
